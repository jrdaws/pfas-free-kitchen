#!/bin/bash
# Pre-commit hook for dawson-does-framework
# Runs validation checks before allowing commit
# 
# Version: 2.0
# Last Updated: 2025-12-22
#
# Installation: Run `./scripts/install-hooks.sh` or manually:
#   cp scripts/hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

set -e

# Check if running in CI mode (called from GitHub Actions)
CI_MODE=false
if [ "${1:-}" = "--ci-mode" ]; then
    CI_MODE=true
fi

echo ""
echo "ğŸ›¡ï¸  Pre-commit Validation (Governance v2.0)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

echo "ğŸ“‹ Step 1: Checking protected files..."

# Core protected files that must exist
CRITICAL_FILES=(
    "AGENT_CONTEXT.md"
    "CLAUDE.md"
    ".cursorrules"
    ".protected-files"
)

# Check if critical files exist
MISSING=()
for file in "${CRITICAL_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        MISSING+=("$file")
    fi
done

# Check if any critical files are being deleted in this commit
DELETED_CRITICAL=()
for file in "${CRITICAL_FILES[@]}"; do
    if git diff --cached --name-only --diff-filter=D | grep -q "^${file}$"; then
        DELETED_CRITICAL+=("$file")
    fi
done

# Check protected files from .protected-files manifest
if [ -f ".protected-files" ]; then
    while IFS= read -r line || [ -n "$line" ]; do
        # Skip comments and empty lines
        [[ "$line" =~ ^#.*$ ]] && continue
        [[ -z "$line" ]] && continue
        
        # Skip glob patterns (we only check explicit files)
        [[ "$line" =~ \* ]] && continue
        
        # Check if this file is being deleted
        if git diff --cached --name-only --diff-filter=D | grep -q "^${line}$"; then
            DELETED_CRITICAL+=("$line")
        fi
    done < ".protected-files"
fi

# Report missing files
if [ ${#MISSING[@]} -gt 0 ]; then
    echo ""
    echo "âŒ ERROR: Critical files are missing from working directory!"
    echo ""
    for file in "${MISSING[@]}"; do
        echo "   Missing: $file"
    done
    echo ""
    echo "   Restore with: git checkout HEAD -- <file>"
    echo ""
    exit 1
fi

# Report deleted files
if [ ${#DELETED_CRITICAL[@]} -gt 0 ]; then
    echo ""
    echo "âŒ ERROR: Cannot delete protected files!"
    echo ""
    for file in "${DELETED_CRITICAL[@]}"; do
        echo "   Attempting to delete: $file"
    done
    echo ""
    echo "   These files are protected. Unstage with:"
    echo "   git reset HEAD -- <file>"
    echo ""
    exit 1
fi

# Check for .agent-lock file (warn if committing while locked by another agent)
if [ -f ".agent-lock" ]; then
    LOCK_AGENT=$(head -1 .agent-lock 2>/dev/null || echo "unknown")
    LOCK_TIME=$(sed -n '2p' .agent-lock 2>/dev/null || echo "unknown")
    
    echo ""
    echo "âš ï¸  WARNING: Agent lock file exists!"
    echo "   Locked by: $LOCK_AGENT"
    echo "   Since: $LOCK_TIME"
    echo ""
    echo "   If this is your lock, proceed. Otherwise, coordinate with the other agent."
    echo ""
    # Don't block, just warn
fi

echo "âœ… Protected files check passed"
echo ""

# ============================================================================
# Step 2: Check for forbidden patterns
# ============================================================================
echo "ğŸ“‹ Step 2: Checking for forbidden patterns..."

ERRORS=0
WARNINGS=0

# Check for console.log in .mjs files (should use logger)
STAGED_MJS=$(git diff --cached --name-only -- '*.mjs' 2>/dev/null || true)
if [ -n "$STAGED_MJS" ]; then
    CONSOLE_LOGS=$(echo "$STAGED_MJS" | xargs grep -l "console\.log" 2>/dev/null || true)
    if [ -n "$CONSOLE_LOGS" ]; then
        echo "   âš ï¸  console.log found in .mjs files (use logger.mjs):"
        echo "$CONSOLE_LOGS" | sed 's/^/      /'
        WARNINGS=$((WARNINGS + 1))
    fi
fi

# Check for .env files being committed
ENV_FILES=$(git diff --cached --name-only 2>/dev/null | grep -E "^\.env" || true)
if [ -n "$ENV_FILES" ]; then
    echo "   âŒ ERROR: .env files staged for commit:"
    echo "$ENV_FILES" | sed 's/^/      /'
    ERRORS=$((ERRORS + 1))
fi

if [ $ERRORS -eq 0 ] && [ $WARNINGS -eq 0 ]; then
    echo "   âœ… No forbidden patterns found"
fi
echo ""

# ============================================================================
# Step 3: Validate commit message format (if not CI mode)
# ============================================================================
if [ "$CI_MODE" = false ]; then
    echo "ğŸ“‹ Step 3: Checking staged changes..."
    
    STAGED_COUNT=$(git diff --cached --name-only | wc -l | tr -d ' ')
    echo "   Files staged: $STAGED_COUNT"
    
    if [ "$STAGED_COUNT" -eq 0 ]; then
        echo "   âš ï¸  No files staged for commit"
        WARNINGS=$((WARNINGS + 1))
    fi
    echo ""
fi

# ============================================================================
# Summary
# ============================================================================
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $ERRORS -gt 0 ]; then
    echo "âŒ Pre-commit FAILED - $ERRORS error(s), $WARNINGS warning(s)"
    echo ""
    echo "   Fix errors before committing."
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo "âš ï¸  Pre-commit PASSED with $WARNINGS warning(s)"
    echo ""
else
    echo "âœ… Pre-commit PASSED - All checks OK"
    echo ""
fi

exit 0


# Export Build Failures - Bug Report

**Date:** 2026-01-04
**Agent:** Testing Agent
**Test Run:** Tier 1 (12 tests)
**Results:** 7 passed, 5 failed (58%)

---

## Summary

5 integrations have build failures that need immediate fixes:

| Priority | Integration | Error Type | Owner |
|----------|-------------|------------|-------|
| **P0** | Stripe | Import path | Website Agent |
| **P0** | Resend | Env var at build | Website Agent |
| **P1** | Sanity | Missing dependency | Platform Agent |
| **P1** | Cloudinary | TypeScript error | Platform Agent |
| **P1** | Novu | TypeScript error | Platform Agent |

---

## Bug #1: T03 Stripe - Wrong Import Path (P0)

**Error:**
```
Module not found: Can't resolve '../../../../lib/supabase'
```

**Files affected:**
- `app/api/stripe/checkout/route.ts`
- `app/api/stripe/portal/route.ts`
- `app/api/stripe/webhook/route.ts`

**Root cause:** Stripe templates import from `../../../../lib/supabase` but Supabase is now at `lib/supabase/index.ts`. The relative path is wrong.

**Fix:** Update import to use `@/lib/supabase` or correct relative path.

**Location:** `templates/saas/integrations/payments/stripe/`

---

## Bug #2: T04 Resend - Build-time Env Var Check (P0)

**Error:**
```
Error: RESEND_API_KEY is not set in environment variables
```

**File affected:**
- `app/api/email/send/route.ts`

**Root cause:** Template throws error at module load time if RESEND_API_KEY is not set. This runs during Next.js build/SSG.

**Fix:** Guard the env var check with runtime detection:
```typescript
// Instead of:
if (!process.env.RESEND_API_KEY) throw new Error('...');

// Use:
export async function POST(request: Request) {
  if (!process.env.RESEND_API_KEY) {
    return NextResponse.json({ error: 'RESEND_API_KEY not configured' }, { status: 500 });
  }
  // ...
}
```

**Location:** `templates/saas/integrations/email/resend/`

---

## Bug #3: T21 Sanity - Missing styled-components (P1)

**Error:**
```
Module not found: Can't resolve 'styled-components'
```

**Root cause:** Sanity SDK requires `styled-components` as a peer dependency but it's not in the generated package.json.

**Fix:** Add to package.json:
```json
"dependencies": {
  "styled-components": "^6.0.0"
}
```

**Location:** `templates/saas/integrations/cms/sanity/`

---

## Bug #4: T23 Cloudinary - ReactNode Type Error (P1)

**Error:**
```
Type error: Type 'string | number | bigint | true | Element | Iterable<ReactNode>' 
is not assignable to type 'Element'.
```

**File:** `components/media/CloudinaryUpload.tsx:30`

**Root cause:** The render prop `children` returns ReactNode but CldUploadWidget expects Element.

**Fix:** Wrap children with proper type assertion or use a default element:
```typescript
{({ open }) => (children ? <>{children}</> : (
  <button type="button" onClick={() => open()}>Upload</button>
))}
```

**Location:** `templates/saas/integrations/imageOpt/cloudinary/`

---

## Bug #5: T25 Novu - ITriggerPayload Type Error (P1)

**Error:**
```
Type 'Record<string, unknown>' is not assignable to type 'ITriggerPayload'.
```

**File:** `lib/notifications/novu.ts:38`

**Root cause:** The `payload` parameter uses `Record<string, unknown>` but Novu SDK expects `ITriggerPayload`.

**Fix:** Import and use correct type:
```typescript
import type { ITriggerPayload } from '@novu/node';

export async function sendNotification(
  templateId: string,
  userId: string,
  payload?: ITriggerPayload  // Use correct type
) {
  // ...
}
```

**Location:** `templates/saas/integrations/notifications/novu/`

---

## Next Steps

### For Website Agent (P0 - Blocking):
1. Fix Stripe import paths in `templates/saas/integrations/payments/stripe/`
2. Fix Resend build-time env check in `templates/saas/integrations/email/resend/`

### For Platform Agent (P1):
1. Add `styled-components` to Sanity package.json
2. Fix CloudinaryUpload.tsx type error
3. Fix Novu payload type

### Re-run Tests After Fixes:
```bash
npm run test:exports -- --tier=1
```

---

*Bug report generated by Testing Agent | 2026-01-04*


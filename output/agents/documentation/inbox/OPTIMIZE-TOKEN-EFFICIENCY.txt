# Token Efficiency Optimization Task

**Priority**: P0 - Cost Reduction
**Agent**: Documentation Agent (with CLI Agent assist)
**Estimated Savings**: 70-80% reduction in per-session token consumption

---

## Background

Current architecture consumes 12,500-27,000 tokens per session just for bootstrap overhead:
- Memory files: 6-38KB each (growing unbounded)
- Duplicate governance content across AGENT_CONTEXT.md, AGENT_POLICIES.md, .cursorrules
- Heavy bootstrap runs even for simple tasks
- 2,526 lines of governance content across 5 files

This task implements optimizations to reduce costs while preserving quality.

---

## ‚ö†Ô∏è CRITICAL: Backup Original Files First

**Before making ANY changes, archive all original governance files.**

### Step 0: Create Archive Directory and Backup All Files

```bash
#!/bin/bash
# Run this BEFORE any modifications

ARCHIVE_DIR="docs/archive/governance-v2.3-backup"
TIMESTAMP=$(date +%Y%m%d-%H%M)

# Create archive directory
mkdir -p "$ARCHIVE_DIR"

# Backup all governance files that will be modified
cp AGENT_CONTEXT.md "$ARCHIVE_DIR/AGENT_CONTEXT-$TIMESTAMP.md"
cp .cursorrules "$ARCHIVE_DIR/cursorrules-$TIMESTAMP.txt"
cp prompts/agents/AGENT_POLICIES.md "$ARCHIVE_DIR/AGENT_POLICIES-$TIMESTAMP.md"
cp prompts/agents/UNIVERSAL_BOOTSTRAP.md "$ARCHIVE_DIR/UNIVERSAL_BOOTSTRAP-$TIMESTAMP.md"
cp output/shared/MINDFRAME.md "$ARCHIVE_DIR/MINDFRAME-$TIMESTAMP.md"

# Backup all memory files
mkdir -p "$ARCHIVE_DIR/memory"
cp prompts/agents/memory/*_MEMORY.md "$ARCHIVE_DIR/memory/"

# Create manifest of what was backed up
cat > "$ARCHIVE_DIR/MANIFEST.md" << EOF
# Governance Backup Manifest

**Backup Date**: $(date)
**Governance Version**: 2.3
**Reason**: Pre-optimization backup before token efficiency improvements

## Files Backed Up

| Original File | Backup File |
|---------------|-------------|
| AGENT_CONTEXT.md | AGENT_CONTEXT-$TIMESTAMP.md |
| .cursorrules | cursorrules-$TIMESTAMP.txt |
| prompts/agents/AGENT_POLICIES.md | AGENT_POLICIES-$TIMESTAMP.md |
| prompts/agents/UNIVERSAL_BOOTSTRAP.md | UNIVERSAL_BOOTSTRAP-$TIMESTAMP.md |
| output/shared/MINDFRAME.md | MINDFRAME-$TIMESTAMP.md |
| prompts/agents/memory/*.md | memory/*.md |

## Restoration Instructions

To restore any file:
\`\`\`bash
cp docs/archive/governance-v2.3-backup/[BACKUP_FILE] [ORIGINAL_LOCATION]
\`\`\`

To restore everything:
\`\`\`bash
cp docs/archive/governance-v2.3-backup/AGENT_CONTEXT-*.md AGENT_CONTEXT.md
cp docs/archive/governance-v2.3-backup/cursorrules-*.txt .cursorrules
cp docs/archive/governance-v2.3-backup/AGENT_POLICIES-*.md prompts/agents/AGENT_POLICIES.md
cp docs/archive/governance-v2.3-backup/UNIVERSAL_BOOTSTRAP-*.md prompts/agents/UNIVERSAL_BOOTSTRAP.md
cp docs/archive/governance-v2.3-backup/MINDFRAME-*.md output/shared/MINDFRAME.md
cp docs/archive/governance-v2.3-backup/memory/*.md prompts/agents/memory/
\`\`\`
EOF

echo "‚úÖ Backup complete: $ARCHIVE_DIR"
echo "üìã Manifest created: $ARCHIVE_DIR/MANIFEST.md"
ls -la "$ARCHIVE_DIR"
```

**Save this as `scripts/backup-governance.sh` and run it FIRST.**

### Verification Before Proceeding

After backup, verify:
```bash
ls -la docs/archive/governance-v2.3-backup/
cat docs/archive/governance-v2.3-backup/MANIFEST.md
```

**DO NOT proceed with any modifications until backup is confirmed.**

---

## Task 1: Memory Rotation System

### Goal
Keep memory files under 10KB by archiving old sessions.

### Implementation

**Create `scripts/rotate-memory.sh`:**

```bash
#!/bin/bash
# Memory Rotation Script - Keep memory files lean
# Usage: ./scripts/rotate-memory.sh [MAX_SESSIONS]

MAX_SESSIONS=${1:-5}
MEMORY_DIR="prompts/agents/memory"
ARCHIVE_BASE="output/agents"

echo "üîÑ Rotating memory files (keeping last $MAX_SESSIONS sessions)..."

for file in "$MEMORY_DIR"/*_MEMORY.md; do
  [ -f "$file" ] || continue
  
  filename=$(basename "$file")
  agent_name=$(echo "$filename" | sed 's/_MEMORY.md//' | tr '[:upper:]' '[:lower:]')
  archive_dir="$ARCHIVE_BASE/$agent_name/logs"
  
  # Get file size
  size=$(wc -c < "$file" | tr -d ' ')
  
  # Only rotate if > 15KB
  if [ "$size" -gt 15000 ]; then
    echo "  üìÅ $filename ($size bytes) - rotating..."
    
    # Create archive if needed
    mkdir -p "$archive_dir"
    
    # Archive full file with timestamp
    timestamp=$(date +%Y%m%d-%H%M)
    cp "$file" "$archive_dir/memory-archive-$timestamp.md"
    
    # Keep header (everything before "## Session History") + last N sessions
    # Use awk to extract header and last N session blocks
    awk -v max="$MAX_SESSIONS" '
      /^## Session History/ { in_history = 1 }
      /^## Session:/ || /^---$/ && in_history { 
        session_count++
        if (session_count > 0) sessions[session_count] = ""
      }
      in_history { 
        if (session_count > 0) sessions[session_count] = sessions[session_count] $0 "\n"
      }
      !in_history { header = header $0 "\n" }
      END {
        print header
        print "## Session History (Rotated - Last " max " Sessions)\n"
        start = session_count - max + 1
        if (start < 1) start = 1
        for (i = start; i <= session_count; i++) {
          print sessions[i]
        }
      }
    ' "$file" > "${file}.tmp" && mv "${file}.tmp" "$file"
    
    new_size=$(wc -c < "$file" | tr -d ' ')
    echo "    ‚úÖ Reduced: $size ‚Üí $new_size bytes"
  else
    echo "  ‚úì $filename ($size bytes) - OK"
  fi
done

echo "‚úÖ Memory rotation complete"
```

**Make executable:**
```bash
chmod +x scripts/rotate-memory.sh
```

**Add to pre-commit hook or run weekly:**
```bash
# In .husky/pre-commit or manually
./scripts/rotate-memory.sh 5
```

### Archive Retention Policy

Rotated memory content is saved to `output/agents/[agent]/logs/`. Manage these archives with this retention schedule:

| Archive Age | Action | Automation |
|-------------|--------|------------|
| 0-7 days | Keep full `.md` files | None needed |
| 7-30 days | Compress to `.md.gz` | Weekly cron |
| 30-90 days | Move to `output/shared/archive/memory/` | Monthly |
| 90+ days | **Manual review required** | Flag for human review |

**Important**: Memory archives are NEVER auto-deleted. Files older than 90 days are flagged for manual review but preserved until explicitly removed by a human.

**Create `scripts/manage-memory-archives.sh`:**

```bash
#!/bin/bash
# Memory Archive Management - Compress old archives, flag for review
# Usage: ./scripts/manage-memory-archives.sh

ARCHIVE_BASE="output/agents"
SHARED_ARCHIVE="output/shared/archive/memory"
REVIEW_FILE="output/shared/archive/memory/NEEDS_REVIEW.txt"

echo "üì¶ Managing memory archives..."

# Create shared archive if needed
mkdir -p "$SHARED_ARCHIVE"

# Process each agent's logs
for agent_dir in "$ARCHIVE_BASE"/*/logs; do
  [ -d "$agent_dir" ] || continue
  agent_name=$(basename "$(dirname "$agent_dir")")
  
  for archive in "$agent_dir"/memory-archive-*.md; do
    [ -f "$archive" ] || continue
    
    filename=$(basename "$archive")
    # Extract date from filename (memory-archive-YYYYMMDD-HHMM.md)
    archive_date=$(echo "$filename" | grep -oE '[0-9]{8}')
    
    if [ -z "$archive_date" ]; then
      continue
    fi
    
    # Calculate age in days
    archive_epoch=$(date -j -f "%Y%m%d" "$archive_date" "+%s" 2>/dev/null || date -d "$archive_date" "+%s" 2>/dev/null)
    now_epoch=$(date "+%s")
    age_days=$(( (now_epoch - archive_epoch) / 86400 ))
    
    if [ "$age_days" -gt 90 ]; then
      # Flag for manual review (DO NOT DELETE)
      echo "  ‚ö†Ô∏è  $agent_name/$filename ($age_days days) - flagged for review"
      echo "[$agent_name] $filename - $age_days days old - $(date)" >> "$REVIEW_FILE"
      # Move to shared archive for centralized review
      mkdir -p "$SHARED_ARCHIVE/$agent_name"
      mv "$archive" "$SHARED_ARCHIVE/$agent_name/"
      
    elif [ "$age_days" -gt 30 ]; then
      # Move to shared archive (keep uncompressed for easy access)
      echo "  üìÅ $agent_name/$filename ($age_days days) - moving to shared archive"
      mkdir -p "$SHARED_ARCHIVE/$agent_name"
      mv "$archive" "$SHARED_ARCHIVE/$agent_name/"
      
    elif [ "$age_days" -gt 7 ]; then
      # Compress in place
      if [ ! -f "${archive}.gz" ]; then
        echo "  üóúÔ∏è  $agent_name/$filename ($age_days days) - compressing"
        gzip -k "$archive" && rm "$archive"
      fi
    else
      echo "  ‚úì $agent_name/$filename ($age_days days) - keeping"
    fi
  done
done

# Report files needing review
if [ -f "$REVIEW_FILE" ]; then
  review_count=$(wc -l < "$REVIEW_FILE" | tr -d ' ')
  echo ""
  echo "üìã $review_count archives need manual review"
  echo "   See: $REVIEW_FILE"
  echo "   Location: $SHARED_ARCHIVE/"
fi

echo "‚úÖ Archive management complete"
```

---

## Task 2: Slim Bootstrap (Default) + [full] Override

### Goal
Make lightweight bootstrap the DEFAULT. Only run full bootstrap when explicitly requested with `[full]`.

### Implementation

**Replace `.cursorrules` with this optimized version:**

```markdown
# Dawson-Does Framework - Cursor Rules
# Governance Version: 3.0 | Optimized for Token Efficiency

---

## Bootstrap Mode (SLIM by Default)

**SLIM MODE (Default)**: Fast, efficient - skip heavy reads
**FULL MODE**: Use `[full]` prefix for complex/multi-step tasks

### Slim Bootstrap (Runs Automatically)

Your FIRST response should:

1. **Quick Sync** (1 command):
   ```bash
   git pull origin main --quiet && git status --short
   ```

2. **Brief Acknowledgment** (3 lines max):
   ```
   ‚úì Governance 3.0 | Export-first | No protected file deletion
   ‚úì Mode: SLIM (use [full] for heavy tasks)
   Proceeding with task...
   ```

3. **Proceed immediately with user's request**

**DO NOT read** in slim mode:
- AGENT_CONTEXT.md (you know the rules)
- Memory files (unless resuming work)
- PROJECT_PRIORITIES.md (unless checking priorities)
- MINDFRAME.md (unless certifying)

### Full Bootstrap (Only When Requested)

If user message starts with `[full]`:

1. Run complete sync check
2. Read AGENT_CONTEXT.md
3. Read memory file for your role
4. Read PROJECT_PRIORITIES.md
5. Check inbox for pending tasks
6. Then proceed with task

**Trigger phrases for full mode:**
- `[full]` - explicit trigger
- "resume previous work" - needs memory
- "check my inbox" - needs file reads
- "what's the priority" - needs priorities file

---

## Core Rules (Always Apply)

### Philosophy
- Export-first: Everything for local ownership
- Zero lock-in: Platform optional after export

### Code Style
- JavaScript (.mjs): No semicolons, 2-space indent
- TypeScript (.ts/.tsx): Semicolons, 2-space indent
- Commits: Conventional format (feat:, fix:, docs:, chore:)

### Key Commands
```bash
npm test                    # Before committing
./scripts/checkpoint.sh     # Save work
./scripts/rotate-memory.sh  # Keep memory lean
```

### Protected Files (Never Delete)
- AGENT_CONTEXT.md, .cursorrules
- prompts/agents/memory/*.md
- prompts/agents/roles/*.md
- docs/standards/*

### What NOT to Do
- Add unrequested features
- Refactor unrelated code
- Delete protected files
- Create feature branches (work on main)
- Split fenced output blocks

---

## Session End Checklist

Before ending:
1. Run `npm test`
2. Commit: `git add -A && git commit -m "<type>(<scope>): <desc>"`
3. Push: `git push origin main`
4. If significant work: Update memory file (keep brief!)

---

## Agent Identity

End responses with role in caps: `(CLI AGENT)`, `(WEBSITE AGENT)`, etc.

---

## Token Efficiency Rules

1. **Memory files**: Keep sessions brief (5-10 lines each)
2. **Don't read files you don't need**
3. **Batch file reads** when possible
4. **Skip verification questions** in slim mode
5. **No verbose acknowledgments** - 3 lines max
```

---

## Task 3: Consolidate Governance Files

### Goal
Reduce governance from 2,526 lines to ~500 lines while preserving all rules.

### Implementation

**Step 1: Archive ALL original files (see Step 0 above)**

**Step 2: Archive CLAUDE.md (if exists)**
```bash
[ -f CLAUDE.md ] && mv CLAUDE.md docs/archive/governance-v2.3-backup/CLAUDE.md
```

**Step 3: Extract Version History from AGENT_POLICIES.md**

Move lines 1184-1310 (version history) to archive:
```bash
# Create changelog archive
mkdir -p docs/archive
# The version history section will be moved during the consolidation
```

**Step 4: Create Condensed AGENT_CONTEXT.md**

Reduce from 347 lines to ~100 lines. Keep only:
- Project Vision (2 lines)
- Architecture Overview (directory tree)
- Key Flows (3 bullet points)
- Coding Standards (condensed table)
- Protected Files list
- Agent Identity section

**REMOVE from AGENT_CONTEXT.md:**
- 5-question verification test (wastes output tokens)
- Detailed script listings (reference docs/scripts/)
- Duplicate philosophy explanations

**Target size: 100 lines, ~4KB (down from 347 lines, 12KB)**

**Step 5: Create Condensed GOVERNANCE.md**

Merge essential content from AGENT_POLICIES.md (1,407 lines) into single reference:

**Keep:**
- Core Principles (condensed to table)
- Role table (keep)
- Essential protocols (condensed)
- SOP list (keep as table)

**REMOVE/ARCHIVE:**
- Version history (126 lines) ‚Üí `docs/archive/governance-changelog.md`
- Detailed examples (keep 1 per concept, remove duplicates)
- Media pipeline standards (move to separate doc)
- Repeated handoff format explanations (explain once)

**Target size: 400 lines, ~15KB (down from 1,407 lines, 52KB)**

**Step 6: Create Reference Docs for [full] Mode**

Move verbose content to `docs/governance/` for when [full] mode is used:
- `docs/governance/FULL_CONTEXT.md` - Complete policies
- `docs/governance/CHANGELOG.md` - Version history
- `docs/governance/EXAMPLES.md` - Detailed examples

---

## Task 4: Remove Mandatory Verification Test

### Current (wastes ~200 output tokens every session):
```markdown
## üõë MANDATORY VERIFICATION TEST
Answer these 5 questions...
```

### Change to:
```markdown
## Governance Acknowledgment
State: `‚úì Governance 3.0` and proceed.
```

**Implementation:**
Remove the verification test section from AGENT_CONTEXT.md entirely.

---

## Verification

After implementation, verify:

1. **Backup exists:**
   ```bash
   ls -la docs/archive/governance-v2.3-backup/
   cat docs/archive/governance-v2.3-backup/MANIFEST.md
   ```

2. **Memory file sizes:**
   ```bash
   wc -c prompts/agents/memory/*_MEMORY.md | sort -n
   ```
   All should be < 15KB

3. **Governance file sizes:**
   ```bash
   wc -l .cursorrules AGENT_CONTEXT.md
   ```
   Total should be < 200 lines (down from 456)

4. **Bootstrap token count:**
   - Slim mode: < 1,000 tokens
   - Full mode: < 8,000 tokens

---

## Success Metrics

| Metric | Before | After | Savings |
|--------|--------|-------|---------|
| .cursorrules | 109 lines | 110 lines | - (already optimized) |
| AGENT_CONTEXT.md | 347 lines | 100 lines | 71% |
| AGENT_POLICIES.md | 1,407 lines | 400 lines | 72% |
| CLAUDE.md | Existed | Archived | 100% |
| Avg memory file | 400 lines | 150 lines | 62% |
| Bootstrap reads | 6-8 files | 1-2 files | 75% |
| Est. tokens/session (slim) | 3,000 | 750 | 75% |
| Est. tokens/session (full) | 27,000 | 8,000 | 70% |

---

## Deliverables

1. [ ] **FIRST: Run backup script** - `scripts/backup-governance.sh`
2. [ ] Verify backup exists in `docs/archive/governance-v2.3-backup/`
3. [ ] `scripts/rotate-memory.sh` - Memory rotation script
4. [ ] `scripts/manage-memory-archives.sh` - Archive retention management
5. [ ] `output/shared/archive/memory/` - Centralized archive location
6. [ ] Updated `.cursorrules` - Slim-first bootstrap (already done)
7. [ ] Trimmed `AGENT_CONTEXT.md` - 100 lines max
8. [ ] Condensed `GOVERNANCE.md` - Replaces AGENT_POLICIES.md
9. [ ] `docs/governance/CHANGELOG.md` - Version history archive
10. [ ] `docs/governance/FULL_CONTEXT.md` - Verbose content for [full] mode

---

## Rollback Plan

If optimization causes issues:

```bash
# Restore from backup
cp docs/archive/governance-v2.3-backup/AGENT_CONTEXT-*.md AGENT_CONTEXT.md
cp docs/archive/governance-v2.3-backup/cursorrules-*.txt .cursorrules
cp docs/archive/governance-v2.3-backup/AGENT_POLICIES-*.md prompts/agents/AGENT_POLICIES.md
cp docs/archive/governance-v2.3-backup/MINDFRAME-*.md output/shared/MINDFRAME.md

# Restore memory files if needed
cp docs/archive/governance-v2.3-backup/memory/*.md prompts/agents/memory/

echo "‚úÖ Rollback complete - governance restored to v2.3"
```

---

## Next Agent

After completing, hand off to Testing Agent to verify:
1. Slim mode works correctly
2. [full] mode still loads complete context
3. Agents can complete tasks with reduced governance


# TASK: Pattern Swapping UI in Preview

**Priority**: P0
**Wave**: 2 (After Wave 1)
**Assigned To**: Website Agent
**Estimated Effort**: 3-4 hours
**Dependencies**: WAVE1-A-image-generation-all-patterns.txt

---

## Objective

Allow users to swap one pattern for another within the same category directly from the preview. For example, change "Hero Centered Gradient" to "Hero Split Image" without losing content.

---

## Current State

- Pattern registry exists with `getPatternsByCategory()`
- No UI to swap patterns in preview
- Section changes require editing the definition manually

---

## Implementation

### 1. Pattern Swap Dropdown

**File**: `website/components/preview/PatternSwapDropdown.tsx`

```tsx
'use client';

import { useState, useRef, useEffect } from 'react';
import { getPatternsByCategory, getPattern } from '@/lib/patterns/registry';
import type { PatternDefinition, PatternCategory } from '@/lib/patterns/types';

interface PatternSwapDropdownProps {
  currentPatternId: string;
  category: PatternCategory;
  onSwap: (newPatternId: string) => void;
}

export function PatternSwapDropdown({
  currentPatternId,
  category,
  onSwap,
}: PatternSwapDropdownProps) {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);

  const patterns = getPatternsByCategory(category);
  const currentPattern = getPattern(currentPatternId);

  // Close on outside click
  useEffect(() => {
    function handleClickOutside(e: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(e.target as Node)) {
        setIsOpen(false);
      }
    }
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  return (
    <div ref={dropdownRef} className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-white/10 rounded-lg text-sm text-white"
      >
        <SwapIcon className="w-4 h-4" />
        <span className="max-w-[120px] truncate">{currentPattern?.name || currentPatternId}</span>
        <ChevronDownIcon className={`w-4 h-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>

      {isOpen && (
        <div className="absolute top-full left-0 mt-2 w-72 bg-slate-900 border border-white/10 rounded-xl shadow-2xl z-50 overflow-hidden">
          <div className="p-2 border-b border-white/5">
            <p className="text-xs text-white/40 uppercase tracking-wider">
              Switch to another {category} pattern
            </p>
          </div>

          <div className="max-h-80 overflow-y-auto">
            {patterns.map((pattern) => (
              <PatternOption
                key={pattern.id}
                pattern={pattern}
                isCurrent={pattern.id === currentPatternId}
                onSelect={() => {
                  onSwap(pattern.id);
                  setIsOpen(false);
                }}
              />
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

function PatternOption({
  pattern,
  isCurrent,
  onSelect,
}: {
  pattern: PatternDefinition;
  isCurrent: boolean;
  onSelect: () => void;
}) {
  return (
    <button
      onClick={onSelect}
      disabled={isCurrent}
      className={`w-full flex items-center gap-3 p-3 text-left hover:bg-white/5 transition-colors ${
        isCurrent ? 'bg-orange-500/10 border-l-2 border-orange-500' : ''
      }`}
    >
      {/* Pattern thumbnail */}
      <div className="w-16 h-10 bg-slate-800 rounded border border-white/5 flex items-center justify-center">
        <span className="text-lg">{pattern.thumbnail || 'üìê'}</span>
      </div>

      <div className="flex-1 min-w-0">
        <p className={`text-sm font-medium ${isCurrent ? 'text-orange-400' : 'text-white'}`}>
          {pattern.name}
        </p>
        <p className="text-xs text-white/40 truncate">{pattern.description}</p>
      </div>

      {isCurrent && (
        <span className="text-xs text-orange-400">Current</span>
      )}
    </button>
  );
}

// Icons
function SwapIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} 
        d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
    </svg>
  );
}

function ChevronDownIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
    </svg>
  );
}
```

### 2. Section Toolbar Component

Show a floating toolbar when hovering a section:

**File**: `website/components/preview/SectionToolbar.tsx`

```tsx
'use client';

import { PatternSwapDropdown } from './PatternSwapDropdown';
import type { SectionConfig, PatternCategory } from '@/lib/patterns/types';

interface SectionToolbarProps {
  section: SectionConfig;
  index: number;
  totalSections: number;
  onSwap: (newPatternId: string) => void;
  onMoveUp: () => void;
  onMoveDown: () => void;
  onDuplicate: () => void;
  onDelete: () => void;
}

export function SectionToolbar({
  section,
  index,
  totalSections,
  onSwap,
  onMoveUp,
  onMoveDown,
  onDuplicate,
  onDelete,
}: SectionToolbarProps) {
  // Extract category from pattern ID
  const category = getPatternCategory(section.patternId);

  return (
    <div className="absolute top-2 left-1/2 -translate-x-1/2 flex items-center gap-2 p-1.5 bg-slate-900/95 backdrop-blur border border-white/10 rounded-xl shadow-xl z-40">
      {/* Pattern swap dropdown */}
      <PatternSwapDropdown
        currentPatternId={section.patternId}
        category={category}
        onSwap={onSwap}
      />

      <div className="w-px h-6 bg-white/10" />

      {/* Move buttons */}
      <button
        onClick={onMoveUp}
        disabled={index === 0}
        className="p-1.5 hover:bg-white/5 rounded disabled:opacity-30"
        title="Move up"
      >
        <ArrowUpIcon className="w-4 h-4 text-white" />
      </button>
      <button
        onClick={onMoveDown}
        disabled={index === totalSections - 1}
        className="p-1.5 hover:bg-white/5 rounded disabled:opacity-30"
        title="Move down"
      >
        <ArrowDownIcon className="w-4 h-4 text-white" />
      </button>

      <div className="w-px h-6 bg-white/10" />

      {/* Duplicate */}
      <button
        onClick={onDuplicate}
        className="p-1.5 hover:bg-white/5 rounded"
        title="Duplicate section"
      >
        <CopyIcon className="w-4 h-4 text-white" />
      </button>

      {/* Delete */}
      <button
        onClick={onDelete}
        className="p-1.5 hover:bg-red-500/20 rounded"
        title="Delete section"
      >
        <TrashIcon className="w-4 h-4 text-red-400" />
      </button>
    </div>
  );
}

function getPatternCategory(patternId: string): PatternCategory {
  if (patternId.startsWith('hero')) return 'hero';
  if (patternId.startsWith('features')) return 'features';
  if (patternId.startsWith('pricing')) return 'pricing';
  if (patternId.startsWith('testimonial') || patternId.startsWith('logo')) return 'social-proof';
  if (patternId.startsWith('cta')) return 'cta';
  if (patternId.startsWith('faq')) return 'faq';
  return 'hero'; // fallback
}
```

### 3. Content Migration on Swap

When swapping patterns, migrate compatible props:

**File**: `website/lib/patterns/pattern-migration.ts`

```typescript
import type { SectionConfig } from './types';
import { getPattern } from './registry';

/**
 * Migrate props when swapping from one pattern to another.
 * Preserves content where possible, fills defaults for new required props.
 */
export function migratePatternProps(
  oldSection: SectionConfig,
  newPatternId: string
): SectionConfig {
  const oldPattern = getPattern(oldSection.patternId);
  const newPattern = getPattern(newPatternId);

  if (!oldPattern || !newPattern) {
    return { ...oldSection, patternId: newPatternId };
  }

  // Common props that transfer between most patterns
  const transferableProps = [
    'headline', 'title', 'subheadline', 'subtitle', 'description',
    'primaryCTA', 'secondaryCTA', 'cta', 'buttonText', 'buttonUrl',
    'backgroundImage', 'backgroundColor', 'textColor',
  ];

  const newProps: Record<string, any> = {};

  // Transfer matching props
  for (const prop of transferableProps) {
    if (oldSection.props?.[prop] !== undefined) {
      newProps[prop] = oldSection.props[prop];
    }
  }

  // Pattern-specific migrations
  // Hero to Hero: Transfer most content
  if (oldPattern.category === 'hero' && newPattern.category === 'hero') {
    if (oldSection.props?.media && newPattern.id.includes('split')) {
      newProps.media = oldSection.props.media;
    }
  }

  // Features to Features: Transfer features array
  if (oldPattern.category === 'features' && newPattern.category === 'features') {
    if (oldSection.props?.features) {
      newProps.features = oldSection.props.features;
    }
  }

  // Apply new pattern's default props, then overlay migrated props
  const defaults = newPattern.defaultProps || {};

  return {
    ...oldSection,
    patternId: newPatternId,
    variantId: undefined, // Reset variant
    props: {
      ...defaults,
      ...newProps,
    },
  };
}
```

### 4. Update SectionRenderer with Toolbar

**File**: `website/components/preview/SectionRenderer.tsx`

Add toolbar display:

```tsx
export function SectionRenderer({
  section,
  index,
  totalSections,
  definition,
  onSectionChange,
  onSectionDelete,
  onSectionMove,
  onSectionDuplicate,
  editable = false,
}: SectionRendererProps) {
  const [isHovered, setIsHovered] = useState(false);

  const handleSwap = (newPatternId: string) => {
    const migratedSection = migratePatternProps(section, newPatternId);
    onSectionChange?.(migratedSection);
  };

  return (
    <div
      className="relative group"
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {/* Section toolbar - shows on hover in editable mode */}
      {editable && isHovered && (
        <SectionToolbar
          section={section}
          index={index}
          totalSections={totalSections}
          onSwap={handleSwap}
          onMoveUp={() => onSectionMove?.(index, index - 1)}
          onMoveDown={() => onSectionMove?.(index, index + 1)}
          onDuplicate={() => onSectionDuplicate?.(index)}
          onDelete={() => onSectionDelete?.(index)}
        />
      )}

      {/* Section outline on hover */}
      {editable && isHovered && (
        <div className="absolute inset-0 border-2 border-dashed border-orange-500/30 pointer-events-none z-30" />
      )}

      {/* Pattern component */}
      <Component {...finalProps} />
    </div>
  );
}
```

---

## Pattern Thumbnails

Add emoji/icon thumbnails to pattern definitions for the dropdown:

| Pattern ID | Thumbnail |
|------------|-----------|
| hero-centered-gradient | üåÖ |
| hero-split-image | üñºÔ∏è |
| hero-video-bg | üé¨ |
| hero-animated-gradient | ‚ú® |
| features-icon-grid | üî≤ |
| features-bento | üì¶ |
| features-alternating | ‚ÜîÔ∏è |
| testimonials-grid | üí¨ |
| testimonials-carousel | üé† |
| pricing-three-tier | üí∞ |
| cta-simple | üì¢ |
| faq-accordion | ‚ùì |

---

## Success Criteria

- [ ] Hovering section shows toolbar
- [ ] Pattern dropdown shows all patterns in same category
- [ ] Swapping preserves headline/subheadline content
- [ ] Move up/down reorders sections correctly
- [ ] Duplicate creates copy with unique ID
- [ ] Delete removes section with confirmation
- [ ] Toolbar positions correctly at all viewport sizes

---

## Testing

1. Enable editable mode in preview
2. Hover over Hero section - toolbar appears
3. Open pattern dropdown - see all hero patterns
4. Select different pattern - content migrates
5. Move section up/down - order changes
6. Duplicate section - see copy below
7. Delete section - section removed

---

*Created by Documentation Agent*


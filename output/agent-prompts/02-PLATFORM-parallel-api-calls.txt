# Platform Agent Task: Parallel Stage Execution

================================================================================
PRIORITY: MEDIUM
AGENT: Platform Agent
ESTIMATED TIME: 15-25 minutes
================================================================================

## Governance Acknowledgment
Read AGENT_CONTEXT.md and follow all governance rules before proceeding.

## Context
Current `generateProject()` runs 4 stages sequentially:
```
Intent (~2s) → Architecture (~5s) → Code (~60s) → Context (~10s)
Total: ~77 seconds
```

**Optimization Opportunity:** Code and Context stages are INDEPENDENT after Architecture.

```
Intent → Architecture → [Code ‖ Context] (parallel)
Expected savings: ~10 seconds (13% faster)
```

## Your Task
Modify `packages/ai-agent/src/index.ts` to run Code and Context in parallel.

### Step 1: Verify Independence
Check `buildCursorContext()` in `context-builder.ts`:
- It uses: `intent`, `architecture`, `projectName`, `description`
- It does NOT use: `code` output (the generated files)

This confirms Code and Context can run in parallel.

### Step 2: Modify generateProject()

File: `packages/ai-agent/src/index.ts`

Find the sequential code (around line 130-160):
```typescript
// Step 3: Generate code
emit('code', 'start', { message: 'Generating code files...' });
const code = await generateCode(architecture, input, {
  apiKey,
  model: models.code,
  stream,
  onStream: stream ? (chunk, accumulated) => emit('code', 'chunk', { chunk, accumulated }) : undefined,
});
emit('code', 'complete', { message: 'Code generation complete' });

// Step 4: Build Cursor context
emit('context', 'start', { message: 'Building Cursor context...' });
const context = await buildCursorContext(
  {
    intent,
    architecture,
    code,
    projectName: input.projectName,
    description: input.description,
  },
  {
    apiKey,
    model: models.context,
    stream,
    onStream: stream ? (chunk, accumulated) => emit('context', 'chunk', { chunk, accumulated }) : undefined,
  }
);
emit('context', 'complete', { message: 'Cursor context complete' });
```

Replace with parallel execution:
```typescript
// Steps 3 & 4: Generate code and context in PARALLEL
// Context builder doesn't need code output - it uses intent/architecture only
const [code, context] = await Promise.all([
  // Code generation
  (async () => {
    emit('code', 'start', { message: 'Generating code files...' });
    const result = await generateCode(architecture, input, {
      apiKey,
      model: models.code,
      stream,
      onStream: stream ? (chunk, accumulated) => emit('code', 'chunk', { chunk, accumulated }) : undefined,
    });
    emit('code', 'complete', { message: 'Code generation complete' });
    return result;
  })(),
  
  // Context building (parallel with code)
  (async () => {
    emit('context', 'start', { message: 'Building Cursor context...' });
    const result = await buildCursorContext(
      {
        intent,
        architecture,
        // Note: We pass empty code since context builder doesn't use it
        code: { files: [], integrationCode: [] },
        projectName: input.projectName,
        description: input.description,
      },
      {
        apiKey,
        model: models.context,
        stream,
        onStream: stream ? (chunk, accumulated) => emit('context', 'chunk', { chunk, accumulated }) : undefined,
      }
    );
    emit('context', 'complete', { message: 'Cursor context complete' });
    return result;
  })()
]);
```

### Step 3: Verify Context Builder Doesn't Need Code
Check `context-builder.ts` to confirm `code` is only used for type satisfaction, not actual generation:

```bash
grep -n "code" packages/ai-agent/src/context-builder.ts
```

If `code` IS used in the prompts, we may need to keep sequential. Otherwise, parallel is safe.

### Step 4: Build and Test
```bash
cd packages/ai-agent
npm run build
node test-mock.mjs
cd ../..
npm test
```

### Step 5: Measure Speedup (if API key available)
```bash
# Before change (sequential)
time node packages/ai-agent/test-runner.mjs

# After change (parallel)
time node packages/ai-agent/test-runner.mjs
```

Expected: ~10 second improvement on full generation.

### Step 6: Update Memory
Add to `prompts/agents/memory/PLATFORM_MEMORY.md`:

```markdown
### Session: [DATE] - Parallel Stage Execution

**Work Completed**
- ✅ Modified generateProject() to run Code and Context in parallel
- ✅ Verified context-builder doesn't need code output
- ✅ All tests passing

**Performance Impact**
- Before: ~77s total generation
- After: ~67s total generation
- Improvement: ~13%

**Technical Notes**
- Code and Context stages now run via Promise.all()
- Streaming events interleave (both stages emit simultaneously)
- Token tracking records both stages correctly
```

### Step 7: Commit
```bash
git add -A
git commit -m "perf(ai-agent): run code and context generation in parallel"
git push origin main
```

## Success Criteria
- [ ] Code and context run in parallel
- [ ] All 668 tests pass
- [ ] Mock test passes
- [ ] Streaming still works (interleaved events OK)
- [ ] Token tracking accurate
- [ ] ~10s speedup measured (if live API available)

================================================================================
END OF PROMPT
================================================================================

